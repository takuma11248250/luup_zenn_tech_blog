---
title: "ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’Notionã‹ã‚‰dbt docsã«åˆ‡ã‚Šæ›¿ãˆãŸè©±"
emoji: "ğŸš—"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹ã€‚ã©ã¡ã‚‰ã§ã‚‚OK
topics: ["dbt", "document", "ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°", "Notion", "DataEngineering"]
publication_name: "luup_developers"
published: true # å…¬é–‹è¨­å®šï¼ˆtrueã«ã—ã¦mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ä¸€èˆ¬å…¬é–‹é–‹å§‹ï¼‰
published_at: 2023-12-10 00:00 # æœªæ¥ã®æ—¥æ™‚ã‚’æŒ‡å®šã™ã‚Œã°ãã®æ—¥æ™‚ã«äºˆç´„å…¬é–‹ã•ã‚Œã¾ã™
---

ã“ã‚Œã¯ [Luup Advent Calendar 2023](https://adventar.org/calendars/8953) ã® 10 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

ã“ã‚“ã«ã¡ã¯ã€‚Data Engineeringãƒãƒ¼ãƒ ã®æ²³é‡([@matako1124](https://twitter.com/matako1124)) ã§ã™ï¼

å»å¹´ã®ä»Šé ƒã«[ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã«Notionã‚’é¸æŠã—ãŸç†ç”±](https://zenn.dev/luup_developers/articles/data-kouno-20221209)ã¨ã„ã†è¨˜äº‹ã‚’æ›¸ã„ãŸã®ã§ã™ãŒã€ãã‚Œã‚’ä»Šå¹´ã•ã‚‰ã«é€²åŒ–ã•ã›ãŸã‚ˆã¨ã„ã†ãŠè©±ã‚’ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

çµè«–ã‹ã‚‰è¨€ã†ã¨ã€Notionã§ã®ç®¡ç†ã‹ã‚‰dbt docsã«åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œã„ã€Cloud Runã§Hostingã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## æ³¨æ„

- **åŸ·ç­†ã«å½“ãŸã‚Šç´°å¿ƒã®æ³¨æ„ã‚’æ‰•ã£ã¦ãŠã‚Šã¾ã™ãŒã€ä¸ååˆ†ãªèª¬æ˜ã‚„èª¤ã‚ŠãŒã‚ã‚‹å¯èƒ½æ€§ã‚‚ã”ã–ã„ã¾ã™ã€‚**
- **è¨˜äº‹å†…ã§ç´¹ä»‹ã—ã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã¯éƒ¨åˆ†çš„ãªã‚‚ã®ã§ã‚ã‚Šã€å‚è€ƒç¨‹åº¦ã«ã”å‚ç…§ãã ã•ã„ã€‚**

## ç›®æ¬¡

- ãã‚‚ãã‚‚ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨ã¯
- ä»Šã¾ã§ã®èª²é¡Œ
- ã©ã†è§£æ±ºã™ã‚‹ã‹
- ã¾ã¨ã‚
- çµ‚ã‚ã‚Šã«

## ãã‚‚ãã‚‚ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨ã¯

ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨ã¯ä½•ã‹ã«ã¤ã„ã¦ã€æ”¹ã‚ã¦èª¬æ˜ã—ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨ã¯ä¸€è¨€ã§ã„ã†ã¨ã€**ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã®5W1HãŒè¨˜ã•ã‚Œã¦ã„ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**ã¨ã—ã¦æ‰ãˆã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã™ã€‚

- When(ã„ã¤æ›´æ–°ã•ã‚Œã‚‹ã®ã‹)
- Where(ã©ã“ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã®ã‹)
- Who(èª°ãŒä½œã£ãŸã®ã‹)
- What(ä½•ã®ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹ã®ã‹)
- Why(ãªãœä½œã‚‰ã‚ŒãŸã®ã‹)
- How(ã©ã®ã‚ˆã†ãªç›®çš„ã§ä½¿ã‚ã‚Œã‚‹ã®ã‹)

Luupã§ã¯ã€BIãƒ„ãƒ¼ãƒ«ã«Redashã€DataWarehouseã«BigQueryã‚’æ¡ç”¨ã—ã¦ãŠã‚Šã€ã‚¯ã‚¨ãƒªã‚’è‡ªåˆ†ã§æ›¸ã„ã¦åˆ†æã™ã‚‹éã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒå¤šãåœ¨ç±ã—ã¦ãŠã‚Šã¾ã™ã€‚
ãã®ãŸã‚ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¨ã„ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã«ãŠã„ã¦éå¸¸ã«é‡è¦ãªãƒ„ãƒ¼ãƒ«ã®ä¸€ã¤ã¨ã—ã¦ä½ç½®ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

## ä»Šã¾ã§ã®èª²é¡Œ

[å‰å›ã®è¨˜äº‹](https://zenn.dev/luup_developers/articles/data-kouno-20221209)ã§ã”ç´¹ä»‹ã—ã¦ã„ã‚‹ã¨ãŠã‚Šã€ç¾çŠ¶ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã¯Notionã«ã¾ã¨ã¾ã£ã¦ãŠã‚Šã€Airflowã®ä¸­ã§jsonãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã«PageåŒ–ã•ã‚Œã€è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
![datacatalog1](/images/data-kouno-20231210/datacatalog1.png)
![datacatalog2](/images/data-kouno-20231210/datacatalog2.png)

ç´„1å¹´é–“é‹ç”¨ã—ã¦ã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªèª²é¡ŒãŒä¸ŠãŒã£ã¦ãã¾ã—ãŸã€‚

- ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ç”¨ã®jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¯å›æ‰‹å‹•ã§ä½œã‚‹ã®ã¯æ„å¤–ã¨é¢å€’
- ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ãŒä½œæˆã•ã‚Œã¦ã„ãªã„å ´åˆCIã§è½ã¡ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŒã€CIãŒè½ã¡ã¦ã€ã‚«ã‚¿ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ã€ã¾ãŸCIã‚’å›ã™ã¨ã„ã†è¡Œç‚ºè‡ªä½“ãŒæ„å¤–ã¨ã‚¹ãƒˆãƒ¬ã‚¹
- Notionã®ãƒšãƒ¼ã‚¸ã‚’æ¯å›ä½œã‚Šæ›¿ãˆã‚‹ã®ã§ã€NotionPageã®URLãŒæ¯æ—¥å¤‰ã‚ã‚‹(ãƒªãƒ³ã‚¯ã‚’å…±æœ‰ã—ãŸã‚‰æ¬¡ã®æ—¥ã«ã¯é•ã†ãƒªãƒ³ã‚¯ã«ãªã‚‹ã®ã§ä½¿ãˆãªããªã‚‹)

ä¸Šè¨˜ã®ã‚ˆã†ãªèª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ãŒå®Œå…¨è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã€å¸¸ã«æœ€æ–°ã®æƒ…å ±ãŒæ‹…ä¿ã•ã‚Œã‚‹ä»•çµ„ã¿ã«ã™ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã‹æ¤œè¨ã—ã¾ã—ãŸã€‚

## ã©ã†è§£æ±ºã™ã‚‹ã‹

ä¸Šè¨˜ã®ã‚ˆã†ãªèª²é¡ŒãŒä¸ŠãŒã£ã¦ããŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€dbtã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«å°å…¥ã™ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã«å…¥ã£ã¦ã„ã¾ã—ãŸã€‚

dbtã«ã¯dbt docsã¨ã„ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ãŒã¤ã„ã¦ãŠã‚Šã€CLIã§ç°¡å˜ã«ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’ç”Ÿæˆã§ãã‚‹ã®ã§ã€ãã‚Œã‚’å¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã§å…¨ç¤¾ã«å±•é–‹ã§ãã‚Œã°ã€ç¾çŠ¶ã®Notionãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã®ä»£æ›¿ã«ãªã‚‹ã¨è€ƒãˆã¾ã—ãŸã€‚

ãã‚Œã§ã¯å…·ä½“çš„ã«ã©ã†ã„ã†Architectureã§å®Ÿè£…ã—ãŸã®ã‹ã«ã¤ã„ã¦ãŠè©±ã—ã—ã¾ã™ã€‚
ä»Šå›ä¸»ã«æ±‚ã‚ã¦ã„ãŸè¦ä»¶ã¯ä»¥ä¸‹äºŒã¤ã§ã™ã€‚

- Airflowã§å‹•ã‹ã—ã¦ã„ã‚‹dbt coreã«è¿½åŠ ã‚„ä¿®æ­£ãŒåŠ ãˆã‚‰ã‚ŒãŸå ´åˆã€è‡ªå‹•ã§ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚‚æ›´æ–°ã™ã‚‹
- Luupç¤¾å“¡ or æ¥­å‹™å§”è¨— ã®ã¿ãŒé–²è¦§ã§ãã‚‹ã‚ˆã†ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹

ã“ã‚Œã‚’é‹ç”¨å·¥æ•°å°‘ãªãå®Ÿç¾ã•ã›ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªArchitectureã§å®Ÿè£…ã—ã¾ã—ãŸã€‚
![architecture](/images/data-kouno-20231210/architecture.png)

- Cloud Runã§dbt docsã‚’Hostingã™ã‚‹å½¢ã«ã—ã¦ã„ã¾ã™
- CDã«ã¯å½“åˆã‚ˆã‚ŠCloudBuildã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã€CloudBuildä¸Šã§CDã«dbt docs generateã‚’ä»•è¾¼ã‚“ã§ã„ã¾ã™
- Cloud Load Balancing ã¨ Cloud IAPã‚’æŒŸã¿ã€ç¤¾å“¡ãƒ¡ãƒ¼ãƒªã‚¹ã®GoogleGroupã‚’IAPã«è¨­å®šã™ã‚‹ã“ã¨ã§Luupãƒ¡ãƒ³ãƒãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™

ä»¥ä¸‹Cloud Buildã®yamlå®Ÿè£…ä¾‹ã«ãªã‚Šã¾ã™ã€‚

```yaml
# trigger: mainãƒ–ãƒ©ãƒ³ãƒã¸ã®merge
steps:
  - id: "Build image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |-
        docker build \
          -t {image_name} \
          -f {docker_file_name} .
  - id: "Get credential"
    name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud secrets versions access --secret={secret_name} latest > /credential/dest
    volumes:
      - name: "credential"
        path: "/credential"
  - id: "Generate dbt docs"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    volumes:
      - name: "credential"
        path: "/credential"
    args:
      - "-c"
      - |-
        docker run --mount type=volume,src=credential,dst=/credential \
          --env GOOGLE_APPLICATION_CREDENTIALS=/credential/dest \
          {image_name} \
          dbt docs generate --target=$_DBT_TARGET
  - id: "Commit & Push image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "bash"
    args:
      - "-c"
      - |-
        docker commit $(docker ps -a | grep us-central1-docker.pkg.dev | awk '{print $1}') {image_name}
        docker push {image_name}
  - id: "Deploy dbt-docs to cloud run"
    name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |-
        gcloud run deploy dbt-data-catalog \
          --project=$PROJECT_ID \
          --region=us-central1 \
          --image={image_name} \
          --command=bash \
          --args="-c, dbt docs serve --target=$_DBT_TARGET --port 443" \
          --port=443 \
          --allow-unauthenticated \
          --ingress=internal-and-cloud-load-balancing \
          --service-account={service_account} \
          --update-secrets=/credential/dest=dest:latest \
          --update-env-vars GOOGLE_APPLICATION_CREDENTIALS="/credential/dest"
```

ã‚ã¨ã¯Load Balancingã¨IAPã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯AWSã®route53ã§è¨­å®šã—ã¦ã„ã¾ã™ã€‚(ç´°ã‹ã„è¨­å®šæ–¹æ³•ã¯çœç•¥ã—ã¾ã™)
![loadbalancing](/images/data-kouno-20231210/loadbalancing.png)
![iap](/images/data-kouno-20231210/iap.png)

ã“ã‚Œã§è¨­å®šå®Œäº†ã§ã™ã€‚
è¨­å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚
![dbt-docs](/images/data-kouno-20231210/dbt-docs.png)

ç„¡äº‹ã‚¢ã‚¯ã‚»ã‚¹ã«æˆåŠŸã—ã¾ã—ãŸ!

## ã¾ã¨ã‚

ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’Notionã‹ã‚‰dbt docsã«åˆ‡ã‚Šæ›¿ãˆã€Cloud Runã§Hostingã™ã‚‹ã‚ˆã†ã«ã—ãŸã“ã¨ã§ä»¥ä¸‹ã®èª²é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã—ãŸã€‚

- ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ä½œæˆå·¥æ•°ã®å‰Šæ¸›
  - jsonãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ1~2åˆ† â†’ 0åˆ†
  - é–‹ç™ºã®ã¿ã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ
- ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ã®CIãŒä¸è¦ã«ãªã£ãŸ
  - CIã®æ™‚é–“ãŒç´„3~5åˆ†ã®å‰Šæ¸›ã•ã‚ŒãŸ
- æƒ…å ±ãŒãƒªãƒƒãƒã«ãªã£ãŸ
  - ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆã®sqlãŒè¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ
  - ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¾å­˜é–¢ä¿‚ãŒè¦‹ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸ

å®Ÿéš›ã®å‰Šæ¸›å·¥æ•°æ™‚é–“ã¯å°‘ãªã„ã§ã™ãŒã€ãã‚‚ãã‚‚ãƒ‡ãƒ¼ã‚¿ã‚«ã‚¿ãƒ­ã‚°ã‚’ä½œã‚‹å¿…è¦ãŒãªããªã‚Šã€è„³ã®ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ãŒç©ºã„ãŸã“ã¨ã¯å¤§ããªæˆæœã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
é‡è¦ãªã‚¿ã‚¹ã‚¯ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ãªã‚¿ã‚¹ã‚¯ã«ã‚ˆã‚Šå¤šãã®æ™‚é–“ã‚’æŠ•è³‡ã—ã¦ã„ã‘ã‚‹ã‚ˆã†ã«ã™ã‚‹ã«ã¯ã€ã“ã†ã„ã†ã¡ã‚‡ã£ã¨ã—ãŸä»•çµ„ã¿åŒ–ãŒé‡è¦ã ã£ãŸã‚Šã—ã¾ã™ã€‚

## çµ‚ã‚ã‚Šã«

Luupã®ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒ¼ãƒ ã¯ã¾ã ã¾ã ãƒ¡ãƒ³ãƒãƒ¼ãŒè¶³ã‚Šãšã€æœ€å°å·¥æ•°ã§æœ€å¤§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‡ºã™ãŸã‚ã€ä»Šå›ã”ç´¹ä»‹ã—ãŸã‚ˆã†ãªä»•çµ„ã¿åŒ–ã‚’ç©æ¥µçš„ã«æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
Luupã§ã®ãƒ‡ãƒ¼ã‚¿åŸºç›¤æ§‹ç¯‰ã€ãƒ‡ãƒ¼ã‚¿æ´»ç”¨ã«å°‘ã—ã§ã‚‚ã”èˆˆå‘³ãŒã‚ã‚‹æ–¹ã€ãœã²æƒ…å ±äº¤æ›ã¨ã„ã†å½¢ã§ã‚‚ãŠè©±ã—ã§ããŸã‚‰å¬‰ã—ã„ã§ã™ã€‚
https://herp.careers/v1/luup/requisition-groups/7e6ac33f-c7f6-4309-92ab-fd0eab740b12
